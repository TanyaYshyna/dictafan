# 🎯 Принципы работы с Backblaze B2 в Dictafan

## 📊 Текущая ситуация

### Структура хранения данных:

```
static/data/
├── dictations/          ← Финальные диктанты (JSON + аудио)
│   └── dicta_001/
│       ├── sentences.json
│       ├── en/
│       │   ├── sentences.json
│       │   └── *.mp3
│       └── ru/
│           ├── sentences.json
│           └── *.mp3
│
├── temp/                ← Временные файлы при редактировании
│   └── dictation_123/
│       └── en/
│           └── *.mp3
│
└── users/               ← Данные пользователей (планируется БД)
    └── user@email.com/
        └── info.json
```

### Проблемы текущего подхода:

1. **На Railway:**
   - Файлы хранятся на эфемерной файловой системе
   - При перезапуске/пересоздании контейнера файлы могут потеряться
   - Ограниченное место на диске
   - Медленная загрузка больших файлов

2. **Локально:**
   - Файлы хранятся на компьютере
   - Нет синхронизации между локальной и продакшен версией

---

## 🎯 Варианты интеграции B2

### Вариант 1: Только аудиофайлы (текущая реализация) ⚠️

**Что хранится в B2:**
- ✅ Только аудиофайлы (`.mp3`, `.wav`, `.webm` и т.д.)
- ❌ JSON файлы остаются локально

**Структура в B2:**
```
dictafan-dictations/
├── audio/
│   └── dictation_123/
│       └── en/
│           └── file.mp3
└── dictations/
    └── dicta_001/
        └── en/
            └── file.mp3
```

**Плюсы:**
- ✅ Быстро внедрить
- ✅ Аудио — самые большие файлы
- ✅ JSON файлы маленькие, можно хранить локально

**Минусы:**
- ❌ JSON и аудио разделены (неудобно для миграции)
- ❌ Нужно синхронизировать два хранилища
- ❌ При удалении диктанта нужно удалять и JSON, и аудио отдельно

---

### Вариант 2: Всё в B2 (рекомендуется) ✅

**Что хранится в B2:**
- ✅ Все аудиофайлы
- ✅ Все JSON файлы (`sentences.json`, `info.json`)
- ✅ Обложки (`cover.webp`)
- ✅ Временные файлы из `temp/`

**Структура в B2:**
```
dictafan-dictations/
├── dictations/
│   └── dicta_001/
│       ├── sentences.json
│       ├── cover.webp
│       ├── en/
│       │   ├── sentences.json
│       │   └── *.mp3
│       └── ru/
│           ├── sentences.json
│           └── *.mp3
│
└── temp/
    └── dictation_123/
        └── en/
            └── *.mp3
```

**Плюсы:**
- ✅ Всё в одном месте
- ✅ Легко мигрировать/бэкапить
- ✅ Не зависит от файловой системы сервера
- ✅ Можно удалить локальные папки после миграции

**Минусы:**
- ⚠️ Нужно обновить код для чтения JSON из B2
- ⚠️ Немного сложнее реализация

---

### Вариант 3: Гибридный (гибкий подход) 🔄

**Что хранится в B2:**
- ✅ Аудиофайлы
- ✅ Обложки (изображения)
- ⚠️ JSON файлы — опционально (можно переключить)

**Локально:**
- JSON файлы (по умолчанию)
- Кэш для быстрого доступа

**Плюсы:**
- ✅ Гибкость — можно постепенно мигрировать
- ✅ JSON файлы маленькие, можно хранить локально
- ✅ Быстрый доступ к метаданным

**Минусы:**
- ❌ Сложнее поддерживать два хранилища

---

## 🔄 Что происходит с существующими данными?

### Сценарий 1: Только новые файлы в B2

**Существующие данные:**
- Остаются на сервере (Railway) или локально
- Продолжают работать как раньше
- При редактировании старых диктантов файлы могут загрузиться в B2

**Проблема:**
- Дублирование данных (локально + B2)
- Старые диктанты могут потеряться при перезапуске Railway

### Сценарий 2: Миграция существующих данных в B2

**Процесс:**
1. Создаёшь скрипт миграции
2. Скрипт читает все файлы из `static/data/dictations/`
3. Загружает их в B2 с сохранением структуры
4. Обновляет пути в JSON файлах (если нужно)
5. После проверки можно удалить локальные файлы

**Плюсы:**
- ✅ Все данные в безопасном месте
- ✅ Единое хранилище

**Минусы:**
- ⚠️ Нужно время на миграцию
- ⚠️ Нужно проверить, что всё работает

---

## 💻 Как работает локальная версия vs Railway

### Локальная разработка (твой компьютер):

```
┌─────────────────────────────────────┐
│  Твой компьютер                     │
│                                     │
│  static/data/                       │
│  ├── dictations/  ← Локальные файлы │
│  └── temp/                          │
│                                     │
│  .env                               │
│  B2_ENABLED=false  ← B2 отключен    │
└─────────────────────────────────────┘
```

**Поведение:**
- Если `B2_ENABLED=false` или не настроен:
  - ✅ Все файлы сохраняются локально в `static/data/`
  - ✅ Работает как раньше
  - ✅ Ничего не загружается в B2

- Если `B2_ENABLED=true` и ключи настроены:
  - ✅ Файлы сохраняются локально (для разработки)
  - ✅ Также загружаются в B2 (для тестирования)
  - ✅ Можно тестировать интеграцию с B2

### Railway (продакшен):

```
┌─────────────────────────────────────┐
│  Railway Server                     │
│                                     │
│  static/data/                       │
│  ├── dictations/  ← Временные файлы │
│  └── temp/         (могут потеряться)│
│                                     │
│  Environment Variables              │
│  B2_ENABLED=true   ← B2 включен     │
│  B2_APPLICATION_KEY_ID=...          │
│  B2_APPLICATION_KEY=...             │
│  B2_BUCKET_NAME=...                 │
└─────────────────────────────────────┘
         │
         │ Загружает файлы
         ▼
┌─────────────────────────────────────┐
│  Backblaze B2                       │
│                                     │
│  dictafan-dictations/               │
│  ├── dictations/                    │
│  └── temp/                          │
└─────────────────────────────────────┘
```

**Поведение:**
- Если `B2_ENABLED=true`:
  - ✅ Файлы сохраняются локально (временно, для обработки)
  - ✅ Загружаются в B2 (постоянное хранилище)
  - ✅ При перезапуске сервера файлы остаются в B2
  - ✅ При чтении файлов — сначала проверяется B2, потом локально

- Если `B2_ENABLED=false`:
  - ⚠️ Файлы только локально (могут потеряться!)

---

## 🎯 Рекомендуемый подход

### Этап 1: Текущая реализация (только аудио)

**Что делаем:**
1. ✅ Интегрируем B2 для аудиофайлов (уже сделано)
2. ✅ JSON файлы остаются локально
3. ✅ Тестируем на Railway

**Плюсы:**
- Быстро внедрить
- Аудио — самые большие файлы
- Минимальные изменения в коде

### Этап 2: Расширенная интеграция (всё в B2)

**Что делаем:**
1. Обновляем код для чтения JSON из B2
2. Загружаем JSON файлы в B2 при сохранении
3. Создаём скрипт миграции существующих данных
4. Мигрируем все файлы в B2
5. Удаляем локальные папки (или оставляем как кэш)

**Плюсы:**
- Всё в одном месте
- Надёжное хранение
- Легко бэкапить

---

## 📝 Как работает код сейчас (после интеграции)

### Загрузка файла:

```python
# 1. Файл сохраняется локально (для обработки)
audio.save(local_path)

# 2. Если B2 включен — загружается в B2
if b2_storage.enabled:
    b2_url = b2_storage.upload_file(local_path, remote_path)
    return b2_url  # Возвращаем URL из B2
else:
    return local_path  # Возвращаем локальный путь
```

### Чтение файла:

```python
# Сейчас код читает файлы локально
# Если файл в B2, нужно обновить код для чтения из B2
# (это следующий этап)
```

### Удаление файла:

```python
# 1. Удаляем локально
os.remove(local_path)

# 2. Если файл в B2 — удаляем из B2
if b2_storage.enabled and is_b2_url(filepath):
    b2_storage.delete_file(remote_path)
```

---

## 🔄 Миграция существующих данных

### Скрипт миграции (пример):

```python
import os
from helpers.b2_storage import b2_storage

def migrate_dictations_to_b2():
    """Мигрирует все диктанты в B2"""
    dictations_path = 'static/data/dictations'
    
    for dictation_id in os.listdir(dictations_path):
        dictation_dir = os.path.join(dictations_path, dictation_id)
        
        # Загружаем все файлы
        for root, dirs, files in os.walk(dictation_dir):
            for file in files:
                local_path = os.path.join(root, file)
                # Формируем путь в B2
                rel_path = os.path.relpath(local_path, dictations_path)
                remote_path = f"dictations/{rel_path.replace(os.sep, '/')}"
                
                # Загружаем в B2
                b2_storage.upload_file(local_path, remote_path)
                print(f"Загружено: {remote_path}")
```

---

## ❓ Частые вопросы

### 1. Что будет с существующими диктантами на Railway?

**Ответ:** Они останутся на сервере, но при следующем сохранении/редактировании файлы загрузятся в B2. Для полной миграции нужен скрипт.

### 2. Можно ли хранить всё в B2, включая JSON?

**Ответ:** Да! Нужно обновить код для чтения JSON из B2. Это следующий этап.

### 3. Что будет с локальной разработкой?

**Ответ:** Если `B2_ENABLED=false`, всё работает как раньше — файлы локально. Если `true`, файлы также загружаются в B2 (можно тестировать).

### 4. Нужно ли удалять локальные файлы после миграции?

**Ответ:** Можно оставить как кэш для быстрого доступа, или удалить для экономии места. B2 — основное хранилище.

### 5. Как синхронизировать локальную и продакшен версию?

**Ответ:** Если всё в B2, синхронизация не нужна — оба читают из одного места. Если только аудио в B2, JSON нужно синхронизировать отдельно.

---

## 🎯 Рекомендации

1. **Сейчас:** Используй вариант 1 (только аудио) для быстрого внедрения
2. **Потом:** Переходи на вариант 2 (всё в B2) для полной миграции
3. **Локально:** Оставь `B2_ENABLED=false` для разработки
4. **Railway:** Включи `B2_ENABLED=true` для продакшена
5. **Миграция:** Создай скрипт для переноса существующих данных

---

## 📚 Следующие шаги

1. ✅ Интеграция B2 для аудио (сделано)
2. ⏳ Тестирование на Railway
3. ⏳ Обновление кода для чтения JSON из B2
4. ⏳ Создание скрипта миграции
5. ⏳ Миграция существующих данных
6. ⏳ Удаление локальных файлов (опционально)

